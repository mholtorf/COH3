---
title: "Central Oregon Hashes"
output: blastula::blastula_email
editor: visual
---

```{r}
#| echo: false
#| warning: false

#remotes::install_github("petermeissner/ical")

library("ical")
library("tidyverse")

#events <- ical_parse_df("https://calendar.google.com/calendar/ical/6ureum96qhgf13kj820i61ovq8%40group.calendar.google.com/public/basic.ics")

events <- ical_parse_df("https://calendar.google.com/calendar/ical/cae3r4u2uhucmmi9rvq5eu6obg%40group.calendar.google.com/public/basic.ics")

events <- 
  events %>%
  mutate(description = gsub("\n", "<br>", description),
         day = as.character(wday(dtstart, label = TRUE, abbr = FALSE)),
         date = format(dtstart, format = "%B %d"),
         time = format(dtstart, format = "%I:%M %p"),
         location = if_else(is.na(location),
                       "TBD",
                       location),
         description = if_else(is.na(description), 
                          "Detrails to follow", 
                          location),
         description = gsub("facebook\\.com/[a-zA-Z0-9._]+", "", description)) %>%
  arrange(dtstart)

nextweek <- 
  events %>%
  mutate(difftime = difftime(as.Date(dtstart), 
                    as.Date(Sys.Date()),
                             units = "days")) %>%
  filter(as.Date(dtstart) > Sys.Date() & # Future events
           difftime(as.Date(dtstart), 
                    as.Date(Sys.Date()), 
                    units = "days") == 7) # Within next 10 days

updates <- 
  events %>%
  filter(difftime(as.Date(dtstart), 
                    as.Date(Sys.Date()),
                  units = "days") < 10 & # Within next 10 days
           difftime(last.modified, 
                    Sys.Date(),
                  units = "hours") > -24) # New updates in last 24 hours

upcoming <- 
  events %>%
  filter(dtstart >= Sys.Date() + 10) 
```
```{r}
#| echo: FALSE
#| results: 'asis'

if(nrow(updates) > 0)
  {
  cat('## Late breaking updates!')
  for (i in 1:nrow(updates)) {
    cat(paste0("  \n", "### ", updates[i, "summary"]))
    cat('\n')
    cat("  \n", "**Date:**", updates[i, "day"], nextweek[i, "date"])
    cat("  \n", "**Time:**", updates[i, "time"])
    cat("  \n", "**Where:**", updates[i, "location"])
    cat("  \n\n", updates[i, "description"])
    cat('\n')
    }
  }
```

```{r}
#| echo: FALSE
#| results: 'asis'

if(nrow(nextweek) > 0) 
  {
  cat('## Cumming soon...')
  for (i in 1:nrow(nextweek)) {
    cat(paste0("  \n", "### ", nextweek[i, "summary"]))
    cat('\n')
    cat("  \n", "**Date:**", nextweek[i, "day"], nextweek[i, "date"])
    cat("  \n", "**Time:**", nextweek[i, "time"])
    cat("  \n", "**Where:**", nextweek[i, "location"])
    cat("  \n\n", nextweek[i, "description"])
    cat('\n')
    }
  }
```

## More shenanigans ahead!
*(who said head??)*

```{r}
#| echo: FALSE
#| results: 'asis'

if(nrow(upcoming) > 0)
{
  cat('\n')
  cat("Mark your calendars for the following upcoming events:")
  cat('\n')
  for (i in 1:nrow(upcoming)) {
    cat(paste0("  \n", "### ", upcoming[i, "summary"]))
    cat('\n')
    cat("  \n", "**Date:**", upcoming[i, "day"], upcoming[i, "date"])
    cat("  \n", "**Time:**", upcoming[i, "time"])
    cat("  \n", "**Where:**", upcoming[i, "location"])
    cat("  \n\n", upcoming[i, "description"])
    cat('\n')
  }
}else{
    cat("No other upcoming events. [Sign up to hare!](https://sites.google.com/site/centraloregonhhh/home)")
    }
```
